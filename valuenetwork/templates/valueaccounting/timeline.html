{% extends "site_base.html" %}

{% load i18n %}
{% load thumbnail %}

{% block head_title %}{% trans "Timeline" %}{% endblock %}

{% block extra_head %}
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://api.simile-widgets.org/timeline/2.3.1/timeline-api.js?bundle=true,defaultLocale=en" type="text/javascript"></script>

<style>

	tr.even td 
	{
		color:#000000;
		background-color:#EAF2D3;
	}

	th
	{
		background-color:#C8D6E8;
	}

</style>
{% endblock %}

{% block body_class %}projects{% endblock %}

{% block body_base %}
    <div class="container">
        {% include "_messages.html" %}
		<h1>{% trans "Timeline" %}</h1>
		<p>{% trans "Double-click on months to slide days. Click on event in day to show details." %}</p>	
		<div id="my-timeline" style="height: 300px; border: 1px solid #aaa"></div>

		{% if unassigned %}
			<div style="margin-top: 1em;" >
				<h4>Unassigned Tasks</h4>
				<table class="table table-bordered table-hover table-condensed" >
					<thead>
						<th>Due Date</th>
						<th>Process</th>
						<th>Project</th>
						<th>Description</th>
						<th>Url</th>
						<th>Role</th>
						<th>Type</th>
                        <th>&nbsp;</th>
					</thead>
					<tbody>
						{% for c in unassigned %}
							<tr class="{% cycle 'odd' 'even' %}">
								<td>
									<a href="#" class="duedate" title="Click to locate on Timeline">
										{{ c.due_date }}
									</a>
								</td>
								<td>{{ c.process }}</td>
								<td>{{ c.project }}</td>
								{% if c.description %}
									<td>{{ c.description|urlize|linebreaks }}</td>
								{% elif c.process.description %}
									<td>{{ c.process.description|urlize|linebreaks }}</td>
								{% else %}
									<td>&nbsp;</td>
								{% endif %}
								{% if c.url %}
									<td><a href="{{ c.url }}">Open</a></td>
								{% elif c.process.url %}
									<td><a href="{{ c.process.url }}">Open</a></td>
								{% else %}
									<td>&nbsp;</td>
								{% endif %}
								<td>{{ c.from_agent_role }}</td>
								<td>{{ c.resource_type }}</td>
								<td><button>Take it!</button></td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		{% endif %}
    </div>

<script>
var tl;
$(document).ready(function() {
   var eventSource = new Timeline.DefaultEventSource();
   var bandInfos = [
     Timeline.createBandInfo({
         eventSource:    eventSource,
         date:           "{{ timeline_date }}",
         width:          "70%", 
         intervalUnit:   Timeline.DateTime.DAY, 
         intervalPixels: 100
     }),
     Timeline.createBandInfo({
         overview:       true,
         eventSource:    eventSource,
         date:           "{{ timeline_date }}",
         width:          "30%", 
         intervalUnit:   Timeline.DateTime.MONTH, 
         intervalPixels: 200
     })
   ];
   bandInfos[1].syncWith = 0;
   bandInfos[1].highlight = true;
   
   tl = Timeline.create(document.getElementById("my-timeline"), bandInfos);

	Timeline.GregorianDateLabeller.prototype.labelPrecise = function(date) {
	    return SimileAjax.DateTime.removeTimeZoneOffset(
    	    date, 
    	    this._timeZone //+ (new Date().getTimezoneOffset() / 60)
    	).toLocaleDateString();
	};

	tl.loadJSON("{% url json_timeline %}", function(data, url) {
    	eventSource.loadJSON(data, url);
  	});

	$(".duedate").click(function() 
	{
		var date = this.text;
		tl.getBand(0).setCenterVisibleDate(Timeline.DateTime.parseGregorianDateTime(date));
	});

 });

 var resizeTimerID = null;
$(window).resize(function() {
     if (resizeTimerID == null) {
         resizeTimerID = window.setTimeout(function() {
             resizeTimerID = null;
             tl.layout();
         }, 500);
     }
 });
</script>
{% endblock %}
