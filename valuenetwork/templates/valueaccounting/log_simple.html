{% extends "site_base.html" %}

{% load i18n %}
{% load url from future %}
{% load bootstrap_tags %}
{% load staticfiles %}

{% block head_title %}{% trans "Log Design Contributions" %}{% endblock %}

{% block extra_head %}

<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
<link rel="stylesheet" href="{% static 'css/chosen.css' %}" />

<style>

.item-description
{
	width: 90%;
    height: 4em;
}
.url, .item-name
{
  width: 90%;
}
.save {
    margin-top: 3em;
}
.section {
    color: firebrick;
}
#id_cite-resource 
{
    width: 35em;
}
#citation-list li 
{
    list-style-type: none;
    font-size: 1.3em;
    width: 100%;
    margin-top: 10px;
    padding-left: 0;
}
#citation-list
{
    width: 90%;
}

</style>

{% endblock %}

{% block body_class %}log{% endblock %}

{% block body_base %}
<div class="container">
    {% include "_messages.html" %}

    <form id="simpleForm" method="POST" action="">

	    <legend>
            {% trans "Log Contribution for " %} {{ member.name }} 
            <span class="select-pattern"></span>
        </legend>

	    {% csrf_token %}
        <div class="row-fluid">
            <div class="span6">
				<legend class="section">{% trans "Resource Created" %}:</legend>
				{{ output_form|as_bootstrap }}
				{{ resource_form|as_bootstrap }}
            </div>
            <div class="span6">
				<legend class="section" >{% trans "Work Done" %}:</legend>
				{{ work_form|as_bootstrap }}

				<legend class="section" style="margin-top: 1em;">{% trans "Citations" %}:</legend>
                <a href="#addCiteModal" role="button" class="btn" data-toggle="modal">{% trans "+ cite" %}</a>
                <ul id="citation-list"></ul>

            </div>
	   	</div>

        <div class="row-fluid">
            <div class="span12 save">
			    <input type="submit" name="save" value="{% trans 'Save' %}" class="btn btn-primary" /> 
			</div>
	   	</div>

        <!--modal for adding citations-->
        <div class="modal hide fade" id="addCiteModal" tabindex="-1" role="dialog" aria-labelledby="cite-label" aria-hidden="true">
            <div class="modal-header">
	            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                <h3 id="cite-label">{% trans "Add a citation" %}</h3>
            </div>
            <div class="modal-body">

	              {{ citations_select_form|as_bootstrap }}

	              <div class="modal-footer">
		            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
		            <button id="select-resource" class="btn btn-primary" onclick="addCitation(); return false;">{% trans "Add citation" %}</button>
	              </div>
            </div>
        </div>

    </form>

</div>
{% endblock %}
{% block extra_script %}
	<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.10.0/jquery.validate.min.js"></script>
	<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
	<script src="{% static 'js/RelatedObjectLookups.js' %}"></script>
	<script src="{% static 'js/chosen.jquery.js' %}"></script>
{% endblock %}

{% block extra_body %}
	{{ block.super }}

    <script type="text/javascript">

    $(document).ready(function(){


	    $( "#help" ).toggle( function(){
            $('#help-content').show("slide", { direction: "right" }, "slow" ); 
        }, function() {
            $('#help-content').hide("slide", { direction: "right" }, "slow"); 
        })

        $('.date-entry').datepicker({ dateFormat: "yy-mm-dd" });

        jQuery.validator.setDefaults({ 
            success: function(label) {
		        label
			        .text('').addClass('valid')
			        .closest('.control-group').addClass('success');
	        }
        });

        $(".chzn-select").chosen();
        $(".resource-type-selector").change(updateList);

        function updateList(event)
        {
            $(".chzn-select").trigger("liszt:updated");
        }

		$( "#simpleForm" ).validate({
			rules: {
			    'resource-identifier': {
                    required: true
				},
			    'resource-url': {
                    required: true
				},
			    'resource-notes': {
                    required: true
				},
				'event_date': {
                    required: true,
					date: true
				}
			},
			highlight: function(label) {
				$(label).closest('.control-group').addClass('error');
			},
		});

    }); // end document.ready

    function getResources()
	{
        var selectedRT = document.getElementById('id_cite-resource_type').value; 
        var jsonUrl = encodeURI("/accounting/json-resourcetype-resources/" + selectedRT + "/");
        $("#id_cite-resource").empty();
	    $.get(jsonUrl,
		    function(data){
                for(var i=0 ; i<data.length ; i++)
                {
                    var id = data[i]['pk'];
                    var name = data[i].fields['identifier']; 
                    $("#id_cite-resource").append('<option value="' + id + '">' + name + '</option>') 
                }
		    });
	}

    function addCitation()
    {
        var selectedResource = document.getElementById('id_cite-resource');
        var resourceText = selectedResource.options[selectedResource.selectedIndex].text;
        var resourceID = selectedResource.options[selectedResource.selectedIndex].value;
        $("#citation-list").append("<li id='li-" + resourceID + "'>" +  resourceText + 
            "<input type='hidden' name='citation' value='" + resourceID + "' />&nbsp;&nbsp;<button id='cite-remove-" + resourceID + 
            "' class='btn btn-warning btn-mini' title='remove' onclick='$(this).parent().remove(); return false;'>{% trans 'Remove' %}</button></li>");
        $('#addCiteModal').modal('hide');
    }


    </script>
    
{% endblock %}
