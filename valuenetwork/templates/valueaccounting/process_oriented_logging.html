{% extends "site_base.html" %}

{% load staticfiles %}
{% load i18n %}
{% load bootstrap_tags %}

{% block head_title %}{% trans "Process" %}: {{ process }}{% endblock %}

{% block extra_head %}

<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
<link rel="stylesheet" href="{% static 'css/chosen.css' %}" />

<style>

.use {
    margin-left: 4em;
    font-style: italic;
}

.event {
    margin-left: 2em; 
    margin-bottom: 4px;
}

.commitment {
    margin-top: 4px;
}

.notes {
    margin-left: 1em;
    font-style: italic;
}

.error {
    color: red;
}

.reskedForm {
    display: inline;
}
#addCiteModal textarea, #addConsumableModal textarea, #addUsableModal textarea, #addWorkModal textarea, #addOutputModal textarea, .item-description, #resourceModal textarea {
  width: 500px;
  height: 100px;
}

.workEventModal textarea, .unplannedWorkModal textarea {
  width: 500px;
  height: 400px;
}

.btn {
    margin-left: 10px;
}
h3, h4 {
    color: firebrick;
}
li {
    list-style-type: none;
}
.proc-notes {
    font-style: italic;
    font-weight: normal;
    border: solid 1px gainsboro;
    background-color: honeydew;
    padding: 4px;
    margin: 4px 0 10px 0;
}
.log-section {
    border: solid 1px gainsboro;
    background-color: beige; 
    padding: 4px;
    margin-bottom: 7px;   
}
.modal {
    width: 600px;
}
.subsection-label {
    font-weight: bold;
}
.detail-line {
    margin: 0 0 0 2em;
}
.taken {
    font-style: italic;
    font-weight: bold;
    color: #5C8A8A;
}
.unplanned {
    color: 	#7D1818;
}
.event-label {
    color: green;
    font-weight: bold;
    font-style: normal;
}
.indent {
    margin-left: 3em;
}

.onhand {
    margin-left: 2em;
}

</style>

{% endblock %}

{% block body_class %}work{% endblock %}

{% block body_base %}
    <div class="container">
        {% include "_messages.html" %}
	<div>
	<legend>
		{% trans "Process" %}: <span class="process" >{{ process }} {% if process.started %} - {% trans "Started" %} {{ process.started }}{% endif %} </span>
		{% if agent %}
            <a class="btn btn-info" href="{% url change_process process_id=process.id %}">{% trans "Change" %}</a>
            {% if logger %}
                <a class="btn btn-primary" href="{% url process_finished process_id=process.id %}">
                    {% if process.finished %}
                        {% trans "Unfinish" %}
                    {% else %}
                        {% trans "Finish" %}
                    {% endif %}
                </a>
            {% endif %}
		{% endif %}
	</legend>

	<div class="row-fluid">

		<div class="span8">
          <div class="log-section">
		    <h3 style="margin-bottom: 4px;" >
		        {% trans "Outputs" %}:  
		        {% if logger %}
		            <a href="#addOutputModal" role="button" class="btn btn-primary btn-mini" data-toggle="modal" title="Add an output requirement">
		                {% trans "Add an output requirement" %}
	                </a>
	             {% endif %}
	              {% if agent %}
		                <a href="#unplannedOutputModal" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Log an unplanned output" >
			                {% trans "Log an unplanned output" %}
		                </a>
	                {% endif %}

	        </h3>
		    {% for item in process.outgoing_commitments %}
			    <div>
				    <b>{% trans "Scheduled" %}: 
			        <span class="output-requirement" >
			            {{ item.resource_type.name }}</b> {{ item.quantity }} {{ item.unit_of_quantity }} {% trans "due" %} {{ item.due_date }} 
		            </span>
		            {% if logger %}

                        <a href="#commitmentModal{{ item.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Change output requirement">
			               <i class="icon-edit"></i>
		                </a>
	
		                <div class="modal hide fade commitmentModal" id="commitmentModal{{ item.id }}" tabindex="-1" role="dialog" aria-labelledby="commitment-label" aria-hidden="true">
			                <div class="modal-header">
				                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				                <h3 id="commitment-label">{% trans "Change Requirement" %}</h3>
			                </div>
			                <div class="modal-body">
				                <form class="commitmentForm{{ item.id }}" enctype="multipart/form-data" action="{% url change_commitment commitment_id=item.id %}" method="POST" >
					                {% csrf_token %}
					                {{ item.change_form|as_bootstrap }}
					                <input type="hidden" id="next" name="next" value="process" />
                                    <div class="modal-footer">
                                        <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                        <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                    </div>
				                </form>
			                </div>
		                </div>

		                <form
		                    style="display: inline;" 
                            class="delete-commitment-form" 
                            id="deleteCommitmentForm{{ item.id }}" 
                            action="{% url delete_process_commitment commitment_id=item.id %}" 
                            method="POST" >
                            {% csrf_token %}
                        	<input type="hidden" id="next" name="next" value="process" />
                            <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete output requirement" >X</button>
                        </form>
		                
		                <a href="#resourceModal" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Create a Resource" >{% trans "Log Resource" %}</a>
        
                        <div class="modal hide fade resourceModal" id="resourceModal" tabindex="-1" role="dialog" aria-labelledby="resource-label" aria-hidden="true">
	                        <div class="modal-header">
		                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		                        <h3 id="resource-label">{% trans "Create" %} {{ item.resource_type.name }} {% trans "Resource" %}</h3>
	                        </div>
	                        <div class="modal-body">
		                        <form class="resource-form" id="resourceForm" enctype="multipart/form-data" action="{% url log_resource_for_commitment commitment_id=item.id %}" method="POST" >
			                        {% csrf_token %}
			                        {{ item.resource_create_form|as_bootstrap }}
		                          <div class="modal-footer">
			                        <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
			                        <button class="btn btn-primary">{% trans "Save" %}</button>
		                          </div>


		                        </form>
                            </div>
                        </div>
			        {% endif %}
			    </div>
			    
			    {% if item.description %}
		           <div class="notes"> {{ item.description|urlize|linebreaks }}</div>
	            {% endif %}
			
			    {% for event in item.fulfilling_events %}
				    <div class="event" >
					    <span class="event-label">{% trans "Completed" %}:</span> <span class="event" >{{ event.quantity }} {{ event.unit_of_quantity }} {{ event.event_date }} </span>
					    {% if logger %}
					        {% comment %}
					        <a href="" class="btn btn-info btn-mini" title="Change" ><i class="icon-edit"></i></a>
					        {% endcomment %}
					        <form
					            style="display: inline;" 
                                class="delete-form" 
                                id="deleteForm{{ event.id }}" 
                                action="{% url delete_event event_id=event.id %}" 
                                method="POST" >
                                {% csrf_token %}
                            	<input type="hidden" id="next" name="next" value="process" />
                                <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete production event" >X</button>
                            </form>
					    {% endif %}
					    </br>
					    &nbsp;&nbsp;{% trans "Resource" %}: <a href="{% url resource resource_id=event.resource.id  %}">{{ event.resource }}</a>
					
				    </div>
			    {% endfor %}
		    {% endfor %}


            {% if process.uncommitted_production_events %}
                <h4 class="unplanned">{% trans "Unplanned Production" %}:</h4>
		        {% for event in process.uncommitted_production_events %}
			        <div class="event" >
				        <b>{% trans "Created" %}: <span class="event" >
				            <a href="{% url resource resource_id=event.resource.id  %}">{{ event.resource }}</a></b> 
				            {{ event.quantity }} {{ event.unit_of_quantity }} {{ event.event_date }}</span>
				        {% if logger %}
				            {% comment %}
				            <a href="" class="btn btn-info btn-mini" title="Change" ><i class="icon-edit"></i></a>
				            {% endcomment %}
		                    <form
				                style="display: inline;" 
                                class="delete-form" 
                                id="deleteForm{{ event.id }}" 
                                action="{% url delete_event event_id=event.id %}" 
                                method="POST" >
                                {% csrf_token %}
                            	<input type="hidden" id="next" name="next" value="process" />
                                <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete production event" >X</button>
                            </form>
		                {% endif %}
			        </div>
		        {% endfor %}
	        {% endif %}
        </div>

        
	    {% if work_reqs or process.uncommitted_work_events or "work" in slots %}
		    <div class="log-section">
		        <h3 style="margin-bottom: 4px;" >
		            {% trans "Work" %}: 
		            {% if logger %}
			            <a href="#addWorkModal" role="button" class="btn btn-primary btn-mini" data-toggle="modal" title="Add a work requirement">
		                    {% if worker %}
                                {% trans "Invite a collaborator" %}
                            {% else %}
                                {% trans "Add a work requirement" %}
                            {% endif %}
	                    </a>
                    {% endif %}
		            {% if agent %}
		                <a href="#unplannedWorkModal" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Log unplanned work" >
			                {% trans "Log unplanned work" %}
		                </a>
	                {% endif %}
	            </h3>
            
		        {% for item in work_reqs %}
			        <div class="commitment">
				        <span class="work-requirement" ><b>{{ item.resource_type.name }}:</b> {{ item.quantity }} {{ item.unit_of_quantity }} {% trans "due" %} {{ item.due_date }}</span>
                        {% if logger %}
				            <a href="#commitmentModal{{ item.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Change work requirement">
			                       <i class="icon-edit"></i>
	                        </a>

	                        <div class="modal hide fade commitmentModal" id="commitmentModal{{ item.id }}" tabindex="-1" role="dialog" aria-labelledby="commitment-label" aria-hidden="true">
		                        <div class="modal-header">
			                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
			                        <h3 id="commitment-label">{% trans "Change Requirement" %}</h3>
		                        </div>
		                        <div class="modal-body">
			                        <form class="commitmentForm{{ item.id }}" enctype="multipart/form-data" action="{% url change_commitment commitment_id=item.id %}" method="POST" >
				                        {% csrf_token %}
				                        {{ item.changeform|as_bootstrap }}
				                        <input type="hidden" id="next" name="next" value="process" />
                                        <div class="modal-footer">
                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                        </div>
			                        </form>
		                        </div>
	                        </div>
                        {% endif %}

                    {% if item.from_agent %}
				        <span class="taken">{% trans "Taken by" %}<span class="agent" > {{ item.from_agent.nick }}</span></span>
				        {% with item.fulfilling_events as work_events %}
				            {% if agent == item.from_agent %} 

				                {% if not work_events %}
				                    <form
	                                    style="display: inline;" 
                                        class="uncommit-form" 
                                        id="uncommitForm{{ item.id }}" 
                                        action="{% url uncommit commitment_id=item.id %}" 
                                        method="POST" >
                                        {% csrf_token %}
                                    	<input type="hidden" id="next" name="next" value="process" />
                                        <button style="display: inline;"  class="btn btn-warning btn-mini" title="Uncommit" >X</button>
                                    </form>
				                {% endif %}

				                <a href="#eventModal{{ item.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Log your work" >
					                {% trans "Log work" %}
				                </a>
			
				                <div class="modal hide fade workEventModal" id="eventModal{{ item.id }}" tabindex="-1" role="dialog" aria-labelledby="event-label" aria-hidden="true">
					                <div class="modal-header">
						                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
						                <h3 id="event-label">{% trans "Add Time Contribution" %}</h3>
					                </div>
					                <div class="modal-body">
						                <form class="eventForm{{ item.id }}" enctype="multipart/form-data" action="{% url add_work_event commitment_id=item.id %}" method="POST" >
							                {% csrf_token %}
							                {{ item.work_event_form|as_bootstrap }}
						                  <div class="modal-footer">
							                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
							                <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
						                  </div>
						                </form>
					                </div>
				                </div>
			                {% comment %}
			                {% elif super_logger %}
			                    <button class="btn btn-info btn-mini" title="Log work for {{ item.from_agent }}" >{% trans "Log work" %}</button>
		                    {% endcomment %}
			                {% endif %}
			                {% if work_events %}
			                    <div class="event">
			                        <div class="subsection-label event-label" >{% trans "Work events" %}:</div>
				                    {% for event in work_events %}
					                
					                    {{ event.event_date }} {{ event.quantity }} {{ event.unit_of_quantity.name  }}
					                    
					                    {% if agent == item.from_agent  %}
					                        
							                <a href="#eventModal{{ event.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
								               <i class="icon-edit"></i>
							                </a>
						
							                <div class="modal hide fade workEventModal" id="eventModal{{ event.id }}" tabindex="-1" role="dialog" aria-labelledby="event-label" aria-hidden="true">
								                <div class="modal-header">
									                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
									                <h3 id="event-label">{% trans "Change Time Contribution" %}</h3>
								                </div>
								                <div class="modal-body">
									                <form class="eventForm{{ event.id }}" enctype="multipart/form-data" action="{% url change_work_event event_id=event.id %}" method="POST" >
										                {% csrf_token %}
										                {{ event.work_event_change_form|as_bootstrap }}
										                <input type="hidden" id="next" name="next" value="process" />
                                                        <div class="modal-footer">
                                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                        </div>
									                </form>
								                </div>
							                </div>

							                <form
				                                style="display: inline;" 
                                                class="delete-form" 
                                                id="deleteForm{{ event.id }}" 
                                                action="{% url delete_event event_id=event.id %}" 
                                                method="POST" >
                                                {% csrf_token %}
                                            	<input type="hidden" id="next" name="next" value="process" />
                                                <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete work contribution!" >X</button>
                                            </form>
					                    {% endif %}
					                    {% if event.description %}
			                               <div class="notes"> {{ event.description|urlize|linebreaks }}</div>
		                                {% endif %}
				                    {% endfor %}
				                </div>
				            {% endif %}
		                {% endwith %}
			            
				        </div>
			        {% else %}
					        <span class="taken">{% trans "Unassigned" %} </span>
					        {% if logger %}
				                <form
				                    style="display: inline;" 
                                    class="delete-commitment-form" 
                                    id="deleteCommitmentForm{{ item.id }}" 
                                    action="{% url delete_process_commitment commitment_id=item.id %}" 
                                    method="POST" >
                                    {% csrf_token %}
                                	<input type="hidden" id="next" name="next" value="process" />
                                    <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete work requirement" >X</button>
                                </form>
                            {% endif %}

                            {% if agent %}                           
						        <a href="#commitmentForm{{ item.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
							        {% trans "Take this task" %}
						        </a>

						        <div class="modal hide fade commitmentForm" id="commitmentForm{{ item.id }}" tabindex="-1" role="dialog" aria-labelledby="commitment-label" aria-hidden="true">
							        <div class="modal-header">
								        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
						        <h3 id="commitment-label">{% trans "Take this task" %}: {{ item.resource_type.name }}</h3>
							        </div>
							        <div class="modal-body">

								        <form class="commitmentForm" enctype="multipart/form-data" action="{% url commit_to_task commitment_id=item.id %}" method="POST" >
									        {% csrf_token %}
									        {{ item.commitment_form|as_bootstrap }}
									        <input type="hidden" name="next" value="{{ process.get_absolute_url }}" />
								          <div class="modal-footer">
									        <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
									        <input type="submit" class="btn btn-primary" name="commit" value='{% trans "Commit to this task" %}' />
									        {% comment %}
									        <input type="submit" class="btn btn-primary" name="start" value='{% trans "Start now" %}' />
									        {% endcomment %}
								          </div>
								        </form>
							        </div>
						        </div>
					        {% endif %}
				        </div>
			        {% endif %}
			        {% if item.description and not item.fulfilling_events %}
		               <div class="notes"> {{ item.description|urlize|linebreaks }}</div>
	                {% endif %}
	                {% if not item.from_agent %}
			            {% for source in item.resource_type.producing_agent_relationships %}
				            <p class="detail-line">
					            <b>{% trans "Possible source" %}:</b><span class="agent" > {{ source.agent.name }}</span>
				            </p>
			            {% endfor %}
			        {% endif %}
		        {% endfor %}
		        
                {% if unplanned_work %}
                    <h4 class="unplanned">{% trans "Unplanned Work Events" %}:</h4>
		            {% for event in unplanned_work %}
			            <div >
				            <span class="event" ><span class="event-label">{% trans "Work event" %}: </span><b> {{ event.resource_type.name }}</b> {{ event.quantity }} {{ event.unit_of_quantity }} {{ event.event_date }} <span class="taken">{% trans "Done by" %} {{ event.from_agent.nick }}</span></span>
                            
			                {% if agent == event.from_agent  %}
		                        
				                <a href="#eventModal{{ event.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
					               <i class="icon-edit"></i>
				                </a>
			
				                <div class="modal hide fade workEventModal" id="eventModal{{ event.id }}" tabindex="-1" role="dialog" aria-labelledby="event-label" aria-hidden="true">
					                <div class="modal-header">
						                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
						                <h3 id="event-label">{% trans "Change Time Contribution" %}</h3>
					                </div>
					                <div class="modal-body">
						                <form class="eventForm{{ event.id }}" enctype="multipart/form-data" action="{% url change_unplanned_work_event event_id=event.id %}" method="POST" >
							                {% csrf_token %}
							                {{ event.changeform|as_bootstrap }}
							                <input type="hidden" id="next" name="next" value="process" />
                                            <div class="modal-footer">
                                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                            </div>
						                </form>
					                </div>
				                </div>

				                <form
	                                style="display: inline;" 
                                    class="delete-form" 
                                    id="deleteForm{{ event.id }}" 
                                    action="{% url delete_event event_id=event.id %}" 
                                    method="POST" >
                                    {% csrf_token %}
                                	<input type="hidden" id="next" name="next" value="process" />
                                    <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete work contribution!" >X</button>
                                </form>
		                    {% endif %}

			                {% if event.description %}
		                       <div class="notes indent"> {{ event.description|urlize|linebreaks }}</div>
	                        {% endif %}
				            
			            </div>
		            {% endfor %}
		        {% endif %}
            </div>
	    {% endif %}
          

		  {% if process.citation_requirements or process.uncommitted_citation_events or "cite" in slots %}
            <div class="log-section">
			    <h3>
			        {% trans "Citations" %}: 
			        {% if logger %}
			            <a href="#addCiteModal" role="button" class="btn btn-primary btn-mini" data-toggle="modal" title="Add a citation requirement">
		                    {% trans "Add a citation requirement" %}
	                    </a>
                    {% endif %}
                    {% if agent %}
		                <a href="#unplannedCiteModal" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Log unplanned citation" >
			                {% trans "Log unplanned citation" %}
		                </a>
	                {% endif %}
                </h3>
                    {% if agent %}
                        <div class="modal hide fade" id="unplannedCiteModal" tabindex="-1" role="dialog" aria-labelledby="cite-label" aria-hidden="true">
                            <div class="modal-header">
	                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                <h3 id="cite-label">{% trans "Add an unplanned citation" %}</h3>
                            </div>
                            <div class="modal-body">
                                <form class="cite-form" enctype="multipart/form-data" id="addUnplannedCiteForm" action="{% url add_unplanned_cite_event process_id=process.id %}" method="POST" >
	                              {% csrf_token %}
	                              {{ unplanned_cite_form|as_bootstrap }}
	                              <div class="modal-footer">
		                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
		                            <button id="select-resource" class="btn btn-primary">{% trans "Add citation" %}</button>
	                              </div>
                                </form>
                            </div>
                        </div>

	                {% endif %}

			    {% for item in process.citation_requirements %}
			        <div class="commitment" >
			            <span class="citation-requirement" ><b>{{ item.resource_type }}</b></span>
			            {% if logger %}
			                {% if not item.fulfilling_events %}
		                        <form
		                            style="display: inline;" 
                                    class="delete-commitment-form" 
                                    id="deleteCommitmentForm{{ item.id }}" 
                                    action="{% url delete_process_commitment commitment_id=item.id %}" 
                                    method="POST" >
                                    {% csrf_token %}
                                	<input type="hidden" id="next" name="next" value="process" />
                                    <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete citation requirement" >X</button>
                                </form>
                            {% endif %}
                        {% endif %}
			            {% if item.description %}
			                <div class="notes"> {{ item.description|urlize|linebreaks }}</div>
		                {% endif %}

				    </div>
				    
				    {% if item.onhand %}
					    {% for resource in item.onhand %}
						    <div class="onhand" >
							    <b>{% trans "Onhand" %}:</b> <a class="resource" href="{% url resource resource_id=resource.id %}" target="_blank" >{{ resource.label }}</a>
							    {% if resource.id in cited_ids %}
							        <span style="color: green; font-weight: bold;">{% trans "Cited" %}</span>
							        {% if logger %}
						                <form
				                            style="display: inline;" 
                                            class="delete-citation-form" 
                                            id="deleteForm{{ event.id }}" 
                                            action="{% url delete_citation_event commitment_id=item.id resource_id=resource.id %}" 
                                            method="POST" >
                                            {% csrf_token %}
                                        	<input type="hidden" id="next" name="next" value="process" />
                                            <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete citation" >X</button>
                                        </form>
						            {% endif %}
						        {% else %}
						            {% if logger %}
						                <form
		                                    style="display: inline;" 
                                            class="citation-form" 
                                            id="citationForm{{ item.id }}" 
                                            action="{% url log_citation commitment_id=item.id resource_id=resource.id %}" 
                                            method="POST" >
                                            {% csrf_token %}
                                        	<input type="hidden" id="next" name="next" value="process" />
                                            <button style="display: inline;"  class="btn btn-info btn-mini" title="Log citation" >{% trans "Log citation" %}</button>
                                        </form>
						            {% endif %}
							    {% endif %}
						    </div>
					    {% endfor %}
				    {% endif %}
			    {% endfor %}
			    
                {% if process.uncommitted_citation_events %}
                    <h4 class="unplanned">{% trans "Unplanned Citations" %}:</h4>
                    {% for event in process.uncommitted_citation_events %}
			            <div class="event" >
				            <span class="event-label">{% trans "Cited" %}:</span> <b><span class="event" >
				                <a href="{% url resource resource_id=event.resource.id  %}">{{ event.resource.label }}</a></b> {{ event.event_date }}</span>
				            {% if logger %}
					            <form
				                    style="display: inline;" 
                                    class="delete-form" 
                                    id="deleteForm{{ event.id }}" 
                                    action="{% url delete_event event_id=event.id %}" 
                                    method="POST" >
                                    {% csrf_token %}
                                	<input type="hidden" id="next" name="next" value="process" />
                                    <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete citation" >X</button>
                                </form>
					        {% endif %}
			            </div>
		            {% endfor %}
	            {% endif %}
					
            </div>
		  {% endif %}
          
          {% if consume_reqs or uncommitted_consumption or "consume" in slots %}
            <div class="log-section">
            
		        <h3 style="margin-bottom: 4px;" >
		            {% trans "Consumable Inputs" %}: 
		            {% if logger %}
		                <a href="#addConsumableModal" role="button" class="btn btn-primary btn-mini" data-toggle="modal" title="Add a consumable input requirement">
		                    {% trans "Add a consumable input requirement" %}
	                    </a>
		            {% endif %}
		            {% if agent %}
		                <a href="#unplannedConsumptionModal" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Log unplanned consumption" >
			                {% trans "Log unplanned consumption" %}
		                </a>
	                {% endif %}
	            </h3>

	             {% if agent %}
                        <div class="modal hide fade" id="unplannedConsumptionModal" tabindex="-1" role="dialog" aria-labelledby="unplanned-consumption-label" aria-hidden="true">
                            <div class="modal-header">
	                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                <h3 id="unplanned-consumption-label">{% trans "Add unplanned consumption" %}</h3>
                            </div>
                            <div class="modal-body">
                                <form class="consumption-form" enctype="multipart/form-data" id="addUnplannedConsumptionForm" 
                                    action="{% url add_unplanned_input_event process_id=process.id slot='c' %}" method="POST" >
	                              {% csrf_token %}
	                              {{ unplanned_consumption_form|as_bootstrap }}
	                              <div class="modal-footer">
		                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
		                            <button id="select-resource" class="btn btn-primary">{% trans "Add consumption" %}</button>
	                              </div>
                                </form>
                            </div>
                        </div>

	                {% endif %}

	            
		        {% for item in consume_reqs %}
			        <div class="commitment" >
				        <span class="consumable-requirement" ><b>{{ item.resource_type.name }}:</b> {{ item.quantity }} {{ item.unit_of_quantity }} {% trans "due" %} {{ item.due_date }}</span>
				        {% if logger %}
                            <a href="#commitmentModal{{ item.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Change consumption requirement">
			                   <i class="icon-edit"></i>
		                    </a>
	
		                    <div class="modal hide fade commitmentModal" id="commitmentModal{{ item.id }}" tabindex="-1" role="dialog" aria-labelledby="commitment-label" aria-hidden="true">
			                    <div class="modal-header">
				                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				                    <h3 id="commitment-label">{% trans "Change Requirement" %}</h3>
			                    </div>
			                    <div class="modal-body">
				                    <form class="commitmentForm{{ item.id }}" enctype="multipart/form-data" action="{% url change_commitment commitment_id=item.id %}" method="POST" >
					                    {% csrf_token %}
					                    {{ item.changeform|as_bootstrap }}
					                    <input type="hidden" id="next" name="next" value="process" />
                                        <div class="modal-footer">
                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                        </div>
				                    </form>
			                    </div>
		                    </div>
				            
		                    <form
		                        style="display: inline;" 
                                class="delete-commitment-form" 
                                id="deleteCommitmentForm{{ item.id }}" 
                                action="{% url delete_process_commitment commitment_id=item.id %}" 
                                method="POST" >
                                {% csrf_token %}
                            	<input type="hidden" id="next" name="next" value="process" />
                                <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete consumption requirement" >X</button>
                            </form>
                        {% endif %}
			        </div>
			        {% if item.description %}
			           <div class="notes"> {{ item.description|urlize|linebreaks }}</div>
		            {% endif %}
                    {% if item.consumable_resources %}
                    	{% for resource in item.consumable_resources %}
					        <div class="onhand" >
						        <b>{% trans "Onhand" %}:</b> <span class="event" >
						            <a class="resource" href="{% url resource resource_id=resource.id %}" target="_blank" >{{ resource.label }}</a>
						             {{ resource.quantity }} {{ resource.unit_of_quantity }} </span>
						        {% if resource.quantity and logger %}
						            <a href="#consumeEventModal{{ item.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Log your consumption of this resource" >
					                {% trans "Log consumption" %}
				                    </a>
			
				                    <div class="modal hide fade eventModal" id="consumeEventModal{{ item.id }}" tabindex="-1" role="dialog" aria-labelledby="event-label" aria-hidden="true">
					                    <div class="modal-header">
						                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
						                    <h3 id="event-label">{% trans "Log resource consumption" %}</h3>
					                    </div>
					                    <div class="modal-body">
						                    <form class="eventForm{{ item.id }}" enctype="multipart/form-data" 
						                        action="{% url add_consumption_event commitment_id=item.id resource_id=resource.id %}" method="POST" >
							                    {% csrf_token %}
							                    {{ item.consumption_event_form|as_bootstrap }}
						                      <div class="modal-footer">
							                    <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
							                    <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
						                      </div>
						                    </form>
					                    </div>
				                    </div>
					            {% endif %}						    
                                {% for event in resource.consuming_events %}
                                    {% if event.commitment = item %}
							            <div class="use" >
								            <span class="event-label">{% trans "Consumed" %}:</span> <span class="event" >{{ event.quantity }} {{ event.event_date }} </span>
								            {% if logger %}
								                {% comment %}
								                <a href="" class="btn btn-info btn-mini" title="Change" ><i class="icon-edit"></i></a>
								                {% endcomment %}
								                <form
				                                    style="display: inline;" 
                                                    class="delete-form" 
                                                    id="deleteForm{{ event.id }}" 
                                                    action="{% url delete_event event_id=event.id %}" 
                                                    method="POST" >
                                                    {% csrf_token %}
                                                	<input type="hidden" id="next" name="next" value="process" />
                                                    <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete consumption event" >X</button>
                                                </form>
								            {% endif %}
							            </div>
							        {% endif %}
						        {% endfor %}
					        </div>
				        {% endfor %}
			        {% elif item.resource_type.producing_commitments %}
                    	{% for ct in item.resource_type.producing_commitments %}
					        <p class="detail-line">
						        <b>{% trans "Scheduled" %}:</b> 
						        <a href="{{ ct.process.get_absolute_url }}" target="_blank" >{{ ct.quantity }} {{ ct.unit_of_quantity }}  {{ ct.due_date }}</a>
					        </p>
				        {% endfor %}
			        {% else %}
				        {% for source in item.sources %}
					        <p class="detail-line">
						        <b>{% trans "Possible source" %}:</b> <span class="source" >{{ source.agent.name }} {% trans "Lead time" %}: {{ source.lead_time }} {% trans "days" %}</span>
						        <br/>
						        {% comment %}
						        {% if source.too_late %}
						            <form class="reskedForm" id="reskedForm-{{ source.id }}" action="{% url forward_schedule_source commitment_id=item.id source_id=source.id %}" method="POST" >
                                        {% csrf_token %}
                                        <input type="hidden" name="next" value="{% url process_details process_id=process.id %}" />
						                <span class="error" style="margin-left: 2em;">{% trans "Should have purchased" %} {{ source.order_release_date|timesince }} {% trans "ago" %}</span> &nbsp;
						                {% if super_logger %}
                                            <button class="btn btn-warning btn-mini" title="Reschedule forward from purchase release date" >{% trans "Reschedule forward" %}</button>
                                        {% endif %}
                                    </form>
					            {% else %}
						            {% trans "Purchase by:" %}{{ source.order_release_date }}
					            {% endif %}
					            {% endcomment %}
					        </p>
				        {% endfor %}
			        {% endif %}
		        {% endfor %}

                {% if uncommitted_consumption %}
                    <h4 class="unplanned">{% trans "Unplanned Consumption" %}:</h4>
		            {% for event in uncommitted_consumption %}
			            <div class="event" >
				            <span class="event-label">{% trans "Consumed" %}:</span> <b><span class="event" >
				            <a href="{% url resource resource_id=event.resource.id  %}">{{ event.resource.label }}</a> 
				            </b> {{ event.quantity }} {{ event.unit_of_quantity }} {{ event.event_date }}</span>
				            {% if logger %}
				                {% comment %}
				                <a href="" class="btn btn-info btn-mini" title="Change" ><i class="icon-edit"></i></a>
				                {% endcomment %}
		                        <form
				                    style="display: inline;" 
                                    class="delete-form" 
                                    id="deleteForm{{ event.id }}" 
                                    action="{% url delete_event event_id=event.id %}" 
                                    method="POST" >
                                    {% csrf_token %}
                                	<input type="hidden" id="next" name="next" value="process" />
                                    <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete consumption event" >X</button>
                                </form>
			                {% endif %}
			            </div>
		            {% endfor %}
	            {% endif %}
	        </div>
	    {% endif %}
     
	    {% if use_reqs or uncommitted_use  or "use" in slots %}
		    <div class="log-section">
		        <h3 style="margin-bottom: 4px;" >
		            {% trans "Usable Inputs" %}:
		            {% if logger %}
		                <a href="#addUsableModal" role="button" class="btn btn-primary btn-mini" data-toggle="modal" title="Add a usable input requirement">
		                    {% trans "Add a usable input requirement" %}
	                    </a>
		            {% endif %}
		            {% if agent %}
		                <a href="#unplannedUseModal" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Log unplanned use" >
			                {% trans "Log unplanned use" %}
		                </a>
	                {% endif %}
	            </h3>

	            {% if agent %}
                    <div class="modal hide fade" id="unplannedUseModal" tabindex="-1" role="dialog" aria-labelledby="unplanned-use-label" aria-hidden="true">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h3 id="unplanned-use-label">{% trans "Add unplanned use" %}</h3>
                        </div>
                        <div class="modal-body">
                            <form class="use-form" enctype="multipart/form-data" id="addUnplannedUseForm" 
                                action="{% url add_unplanned_input_event process_id=process.id slot='u' %}" method="POST" >
                              {% csrf_token %}
                              {{ unplanned_use_form|as_bootstrap }}
                              <div class="modal-footer">
	                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
	                            <button id="select-resource" class="btn btn-primary">{% trans "Add Use" %}</button>
                              </div>
                            </form>
                        </div>
                    </div>

                {% endif %}

		        {% for item in use_reqs %}
			        <div class="commitment" >
				        <span class="usable-requirement" ><b>{{ item.resource_type.name }}:</b> {{ item.quantity }} {{ item.unit_of_quantity }} {% trans "due" %} {{ item.due_date }}</span>

				        {% if logger %}
				            <a href="#commitmentModal{{ item.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Change use requirement">
			                   <i class="icon-edit"></i>
		                    </a>

		                    <div class="modal hide fade commitmentModal" id="commitmentModal{{ item.id }}" tabindex="-1" role="dialog" aria-labelledby="commitment-label" aria-hidden="true">
			                    <div class="modal-header">
				                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				                    <h3 id="commitment-label">{% trans "Change Requirement" %}</h3>
			                    </div>
			                    <div class="modal-body">
				                    <form class="commitmentForm{{ item.id }}" enctype="multipart/form-data" action="{% url change_commitment commitment_id=item.id %}" method="POST" >
					                    {% csrf_token %}
					                    {{ item.changeform|as_bootstrap }}
					                    <input type="hidden" id="next" name="next" value="process" />
                                        <div class="modal-footer">
                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                        </div>
				                    </form>
			                    </div>
		                    </div>
		                    
		                    <form
		                        style="display: inline;" 
                                class="delete-commitment-form" 
                                id="deleteCommitmentForm{{ item.id }}" 
                                action="{% url delete_process_commitment commitment_id=item.id %}" 
                                method="POST" >
                                {% csrf_token %}
                            	<input type="hidden" id="next" name="next" value="process" />
                                <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete use requirement" >X</button>
                            </form>
                        {% endif %}
                        
			        </div>
			        {% if item.description %}
			           <div class="notes"> {{ item.description|urlize|linebreaks }}</div>
		            {% endif %}
                    {% if item.resource_type.onhand %}
                    	{% for resource in item.resource_type.onhand %}
					        <div class="onhand" >
						        <b>{% trans "Onhand" %}:</b> <span class="resource" >
						        <a class="resource" href="{% url resource resource_id=resource.id %}" target="_blank" >{{ resource.label }}</a> 
						        {{ resource.quantity }} {{ resource.unit_of_quantity }} </span>
						        {% if logger %}
						            <a href="#useEventModal{{ item.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Log your use of this resource" >
					                {% trans "Log use" %}
				                    </a>
			
				                    <div class="modal hide fade eventModal" id="useEventModal{{ item.id }}" tabindex="-1" role="dialog" aria-labelledby="event-label" aria-hidden="true">
					                    <div class="modal-header">
						                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
						                    <h3 id="event-label">{% trans "Log resource use" %}</h3>
					                    </div>
					                    <div class="modal-body">
						                    <form class="eventForm{{ item.id }}" enctype="multipart/form-data" 
						                        action="{% url add_use_event commitment_id=item.id resource_id=resource.id %}" method="POST" >
							                    {% csrf_token %}
							                    {{ item.use_event_form|as_bootstrap }}
						                      <div class="modal-footer">
							                    <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
							                    <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
						                      </div>
						                    </form>
					                    </div>
				                    </div>
						        {% endif %}
                                {% for event in resource.using_events %}
                                    {% if event.commitment = item %}
							            <div  class="use" >
								            <span class="event-label">{% trans "Used" %}:</span> <span class="event" >{{ event.quantity }} {{ item.resource_type.unit_of_use }} {{ event.event_date }}</span>
								            {% if logger %}
								                {% comment %}
								                <a href="" class="btn btn-info btn-mini" title="Change" ><i class="icon-edit"></i></a>
								                {% endcomment %}
								                <form
				                                    style="display: inline;" 
                                                    class="delete-form" 
                                                    id="deleteForm{{ event.id }}" 
                                                    action="{% url delete_event event_id=event.id %}" 
                                                    method="POST" >
                                                    {% csrf_token %}
                                                	<input type="hidden" id="next" name="next" value="process" />
                                                    <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete use event" >X</button>
                                                </form>
								            {% endif %}
							            </div>
							        {% endif %}
						        {% endfor %}
					        </div>
				        {% endfor %}
                    {% elif item.fulfilled_quantity %}
				        <div class="onhand" >
					        <b>{% trans "Onhand" %}:</b> 0 {{ item.unit_of_quantity }}
					        <p class="use" >
						        <span class="event-label">{% trans "Used" %}:</span> {{ item.fulfilled_quantity }} {{ item.resource_type.unit_of_use }}
					        </p>
				        </div>
			        {% elif item.resource_type.producing_commitments %}
                    	{% for ct in item.resource_type.producing_commitments %}
					        <p class="detail-line">
						        <b>{% trans "Scheduled" %}:</b> 
						        <span class="scheduled-receipt" ><a href="{{ ct.process.get_absolute_url }}" target="_blank" >{{ ct.quantity }} {{ ct.unit_of_quantity }}  {{ ct.due_date }}</a></span>
					        </p>
				        {% endfor %}
			        {% else %}
				        {% for source in item.resource_type.producing_agent_relationships %}
					        <p class="detail-line">
						        <b>{% trans "Possible source" %}:</b> <span class="source" >{{ source.agent.name }} {% trans "Lead time" %}: {{ source.lead_time }} {% trans "days" %}</span>
					        </p>
				        {% endfor %}
			        {% endif %}
		        {% endfor %}

                {% if uncommitted_use %}
                    <h4 class="unplanned">{% trans "Unplanned Use" %}:</h4>
		            {% for event in uncommitted_use %}
			            <div class="event" >
				            <span class="event-label">{% trans "Used" %}:</span><b><span class="event" > 
				                <a href="{% url resource resource_id=event.resource.id  %}">{{ event.resource }}</a>
				                </b> {{ event.quantity }} {{ event.unit_of_quantity }} {{ event.event_date }}</span>
				            {% if logger %}
				                {% comment %}
				                <a href="" class="btn btn-info btn-mini" title="Change" ><i class="icon-edit"></i></a>
				                {% endcomment %}
			                    <form
				                    style="display: inline;" 
                                    class="delete-form" 
                                    id="deleteForm{{ event.id }}" 
                                    action="{% url delete_event event_id=event.id %}" 
                                    method="POST" >
                                    {% csrf_token %}
                                	<input type="hidden" id="next" name="next" value="process" />
                                    <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete use event" >X</button>
                                </form>
			                {% endif %}
			            </div>
		            {% endfor %}
	            {% endif %}
	        </div>
	    {% endif %}
          
	    </div>

	    <div class="span4">

		    {% if labnotes %}
			    <h4>
				    <a href="{% url labnotes process_id=process.id %}">Labnotes for this process</a>
			    </h4>
		    {% endif %}

		    <h4>{% trans "Process context" %}:</h4>
		    <p>
		        {% if process.process_pattern %}
		            {{ process.process_pattern }}
	            {% else %}
	                {% if agent %}
	                    <span style="color: red;">
	                    No process pattern. See help.
	                    </span>
	                {% else %}
	                    None
	                {% endif %}
	            {% endif %}
		        
		        <br />
		        {% trans "Project" %}: {{ process.project }}

            {% if process.independent_demand %}
		        <br />
		        {% trans "Order" %}: 
		        <span class="rand-order" >
		            <a href="{% url order_schedule order_id=process.independent_demand.id %}">{{ process.independent_demand }}</a>
	            </span>
	        {% endif %}
	        
		    </p>

			<h4>{% trans "Previous processes" %}:</h4>
			{% for proc in process.previous_processes %}
				<p><span class="process" ><a href="{{ proc.get_absolute_url }}">{{ proc }}</a></span></p>
			{% endfor %}

			<h4>{% trans "Next processes" %}:</h4>
			{% for proc in process.next_processes %}
				<p><span class="process" ><a href="{{ proc.get_absolute_url }}">{{ proc }}</a></span></p>
			{% endfor %}
            <br />

		    {% if process.notes %}
		        <h4>{% trans "Process notes" %}:</h4>
		        <div class="proc-notes" >
			        {{ process.notes|urlize|linebreaks }}
		        </div>
		    {% endif %}	

	    </div>
    </div>

    {% if logger %}
    
	<div class="modal hide fade" id="addOutputModal" tabindex="-1" role="dialog" aria-labelledby="output-label" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>

            <h3 id="output-label">{% trans "Add an output requirement" %}</h3>
            
        </div>
        <div class="modal-body">
            <form class="output-form" enctype="multipart/form-data" id="addOutputForm" action="{% url add_process_output process_id=process.id %}" method="POST" >
	            {% csrf_token %}

                    <p class="modal-line">{% trans "Resource Type" %} </p>
                    <p>{{ add_output_form.resource_type }} 
                    {% comment %}
                    <a href="#createResourceModal" role="button" class="add-another" data-toggle="modal">
                        <img src="{% static 'admin/img/icon_addlink.gif' %}" title="add new"></img>                    
                    </a> 
                    {% endcomment %}
                    </p>                   
                    <p class="modal-line">{% trans "Quantity" %} </p>
                    <p>{{ add_output_form.quantity }} </p>
                    <p class="modal-line">{% trans "Unit of Quantity" %} </p>
                    <p>{{ add_output_form.unit_of_quantity }}</p>
                    <p class="modal-line">{% trans "Description" %} </p>
                    <p class="desc">{{ add_output_form.description }} </p>

              <div class="modal-footer">
	            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
	            <button class="btn btn-primary">{% trans "Add output" %}</button>
              </div>


            </form>
        </div>
    </div>

    <div class="modal hide fade rtmodal" id="createResourceModal" tabindex="-1" role="dialog" aria-labelledby="resource-consumable-create-label" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="resource-consumable-create-label">{% trans "Create a new Resource Type" %}</h3>
        </div>
        <div class="modal-body">
            <form class="resource-create-form" id="resource-create-form" enctype="multipart/form-data" action="." method="POST" >
                {% csrf_token %}
                {{ resource_type_form|as_bootstrap }}
                {{ facet_formset.management_form }}
                <table>
                    {% for form in facet_formset %}
                        <tr><td class="facet-name"> {{ form.facet_name }} </td><td> {{ form.value }} {{ form.facet_id }} </td></tr>
                    {% endfor %}
                </table>

              <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                <input type="submit" name="submit" id="save-resource-type" value="{% trans 'Save' %}" class="btn btn-primary save-resource-type" /> 
                <input type="hidden" name="slot" value="out" />
                <input type="hidden" name="pattern" value="{{ process.process_pattern.id }}" />
              </div>

            </form>

        </div>
    </div>

    <div class="modal hide fade" id="addCiteModal" tabindex="-1" role="dialog" aria-labelledby="cite-label" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>

            <h3 id="cite-label">{% trans "Add a citation requirement" %}</h3>
            
        </div>
        <div class="modal-body">
            <form class="cite-form" enctype="multipart/form-data" id="addCitationForm" action="{% url add_process_citation process_id=process.id %}" method="POST" >
	            {% csrf_token %}

                    {{ add_citation_form|as_bootstrap }}

              <div class="modal-footer">
	            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
	            <button class="btn btn-primary">{% trans "Add citation" %}</button>
              </div>


            </form>
        </div>
    </div>

    <div class="modal hide fade" id="addConsumableModal" tabindex="-1" role="dialog" aria-labelledby="consumable-label" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>

            <h3 id="output-label">{% trans "Add a consumable input requirement" %}</h3>
            
        </div>
        <div class="modal-body">
            <form class="consumable-form" enctype="multipart/form-data" id="addConsumableForm" 
                action="{% url add_process_input process_id=process.id slot='c' %}" method="POST" >
	            {% csrf_token %}

                    {{ add_consumable_form|as_bootstrap }}

              <div class="modal-footer">
	            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
	            <button class="btn btn-primary">{% trans "Add consumable" %}</button>
              </div>


            </form>
        </div>
    </div>

    <div class="modal hide fade" id="addUsableModal" tabindex="-1" role="dialog" aria-labelledby="use-label" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>

            <h3 id="output-label">{% trans "Add a usable input requirement" %}</h3>
            
        </div>
        <div class="modal-body">
            <form class="usable-form" enctype="multipart/form-data" id="addUsableForm" 
                action="{% url add_process_input process_id=process.id  slot='u' %}" method="POST" >
	            {% csrf_token %}

                    {{ add_usable_form|as_bootstrap }}

              <div class="modal-footer">
	            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
	            <button class="btn btn-primary">{% trans "Add usable" %}</button>
              </div>


            </form>
        </div>
    </div>

    <div class="modal hide fade" id="addWorkModal" tabindex="-1" role="dialog" aria-labelledby="work-label" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>

            <h3 id="work-label">
                {% if worker %}
                    {% trans "Invite a collaborator" %}
                {% else %}
                    {% trans "Add a work requirement" %}
                {% endif %}
            </h3>
            
        </div>
        <div class="modal-body">
            <form class="work-form" id="addWorkForm" action="{% url add_process_worker process_id=process.id %}" method="POST" >
	            {% csrf_token %}

                    {{ add_work_form|as_bootstrap }}

              <div class="modal-footer">
	            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
	            <button class="btn btn-primary">
	                {% if worker %}
                    {% trans "Invite collaborator" %}
                {% else %}
                    {% trans "Add work requirement" %}
                {% endif %}
                </button>
              </div>


            </form>
        </div>
    </div>

     {% endif %}

     {% if agent %}

     <div class="modal hide fade unplannedOutputModal" id="unplannedOutputModal" tabindex="-1" role="dialog" aria-labelledby="unplanned-output-label" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="unplanned-output">{% trans "Log Unplanned Output" %}</h3>
        </div>
        <div class="modal-body">
            <form class="unplanned-output-form" enctype="multipart/form-data" action="{% url add_unplanned_output process_id=process.id %}" method="POST" >
                {% csrf_token %}
                {{ unplanned_output_form|as_bootstrap }}
              <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
              </div>
            </form>
        </div>
    </div>

     <div class="modal hide fade unplannedWorkModal" id="unplannedWorkModal" tabindex="-1" role="dialog" aria-labelledby="unplanned-work-label" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="unplanned-work">{% trans "Log Unplanned Time Contribution" %}</h3>
        </div>
        <div class="modal-body">
            <form class="unplanned-work-form" enctype="multipart/form-data" action="{% url add_unplanned_work_event process_id=process.id %}" method="POST" >
                {% csrf_token %}
                {{ unplanned_work_form|as_bootstrap }}
              <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
              </div>
            </form>
        </div>
    </div>

    {% endif %}
 
{% endblock %}
{% block extra_script %}
	<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.10.0/jquery.validate.min.js"></script>
	<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
	<script src="{% static 'js/chosen.jquery.js' %}"></script>
{% endblock %}

{% block extra_body %}
	{{ block.super }}

    <script type="text/javascript">

	$(document).ready(function(){

		$('#work').addClass('active');

		$(".chzn-select").chosen();

		$('.date-entry').datepicker({ dateFormat: "yy-mm-dd" });

		$(".res-ajax").change(getResources);

        jQuery.validator.setDefaults({ 
            success: function(label) {
		        label
			        .text('').addClass('valid')
			        .closest('.control-group').addClass('success');
	        }
        });

        $.validator.addClassRules("quantity", { required: true, number: true, });
        $.validator.addClassRules("quality", { number: true, });
		$.validator.addClassRules("url", { url: true });

	    $(".resource-type-selector").change(getUnit);

		function getUnit(event)
		{
	        $(".chzn-select").trigger("liszt:updated");
		    var resourceId = event.target.value;
		    if (resourceId)
		    {
                var targetId = event.target.id;
			    if (targetId.search("usable") >= 0)
			    {
				    direction = "use";
			    }
			    else
			    {
				    direction = "other";
			    }
			    var prefix = targetId.split('-')[0];
			    var unitName = "#" + prefix + "-unit_of_quantity";
			    var jsonUrl = encodeURI("/accounting/json-directional-unit/" + resourceId + "/" + direction + "/");
			    $.get(jsonUrl,
				    function(data){
					    var unit = data["unit"];
                        $(unitName).val(unit);
				    });
		    }
	    }


        $( "#addOutputForm" ).validate({
			rules: {
			    'output-resource_type': {
                    required: true
				},
				'output-quantity': {
                    required: true,
					number: true,
					min: .01
				}
			},
			highlight: function(label) {
				$(label).closest('.control-group').addClass('error');
			},
		});

		$( "#addConsumableForm" ).validate({
			rules: {
			    'input-resource_type': {
                    required: true
				},
				'input-quantity': {
                    required: true,
					number: true,
					min: .01
				}
			},
			highlight: function(label) {
				$(label).closest('.control-group').addClass('error');
			},
		});

		$( "#addUsableForm" ).validate({
			rules: {
			    'input-resource_type': {
                    required: true
				},
				'input-quantity': {
                    required: true,
					number: true,
					min: .01
				}
			},
			highlight: function(label) {
				$(label).closest('.control-group').addClass('error');
			},
		});

		$( "#addWorkForm" ).validate({
			rules: {
			    'input-resource_type': {
                    required: true
				}
			},
			highlight: function(label) {
				$(label).closest('.control-group').addClass('error');
			},
		});


		$('.commitmentForm').each( function(){
			var form = $(this);

			form.validate({
				highlight: function(label) {
					$(label).closest('.control-group').addClass('error');
				},
			});
		});

		$( "#help" ).toggle( function(){
            $('#help-content').show("slide", { direction: "right" }, "slow" ); 
            $( "#help" ).text("Hide Help");
        }, function() {
            $('#help-content').hide("slide", { direction: "right" }, "slow"); 
            $( "#help" ).text("Show Help");
        })


	}); // end document.ready

    function getResources(event)
	{
        var selectedRT = event.target.value;
        var selectId = event.target.id;
        var selectSplit = selectId.split("-");
        var resourcePrefix = selectSplit[0] + "-" + selectSplit[1];
        var resourceFieldId = "#" + resourcePrefix + "-resource";
        var jsonUrl = encodeURI("/accounting/json-resourcetype-resources/" + selectedRT + "/");
        $(resourceFieldId).empty();
	    $.get(jsonUrl,
		    function(data){
                for(var i=0 ; i<data.length ; i++)
                {
                    var id = data[i]['pk'];
                    var name = data[i].fields['identifier']; 
                    $(resourceFieldId).append('<option value="' + id + '">' + name + '</option>') 
                }
		    });
	}

    </script>

{% endblock %}
