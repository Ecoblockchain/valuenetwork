{% extends "site_base.html" %}

{% load i18n %}
{% load bootstrap_tags %}

{% block head_title %}{% trans "Labnotes for " %} {{ commitment.process.name }}{% endblock %}

{% block extra_head %}


<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />

<style>

textarea {
  width: 100%;
  height: 600px;
}

.days, .hours, .minutes {
	width: 24px;
}


</style>
{% endblock %}

{% block body_class %}work{% endblock %}

{% block body_base %}
    <div class="container">
        {% include "_messages.html" %}
	<div>
		<legend>
			{% trans "Labnotes for " %} {{ commitment.process.name }} {% trans "due " %}  {{ commitment.process.end_date }}
			<span style="font-size: 60%;" > 
				{% trans "Contributor" %}: {{ commitment.from_agent.nick }} {% trans "Date" %}: {{ today }} 
				{% trans "Estimated duration" %}: {{ commitment.quantity }} {{ commitment.unit_of_quantity.abbrev }}
				{% trans "Project" %}: {{ commitment.process.project }}
			</span>
		</legend>

		<div class="row-fluid">
			<div class="span8">

			<form method="POST" action=".">
				{% csrf_token %}
				<div class="control-group">
					<label><b>{% trans "Description of work done" %}:</b></label>
					{{ wb_form.description }}
				</div>
			</div>
			<div class="span4">
				<button role="button" id="start" name="start" class="btn btn-info" >{% trans "Start" %}</button>
				<button role="button" id="stop" name="stop"  class="btn btn-info" disabled="disabled" >{% trans "Stop" %}</button>
				<div class="control-group">
					<label><b>{% trans "Time spent so far" %}:</b></label>
					{{ wb_form.quantity }}
					<span class="help-block">{{ wb_form.quantity.help_text }}</span>
				</div>
				<button class="btn btn-primary" type="submit">{% trans "Submit Time Contribution" %}</button>
			</form>
				<div>
					<h4>{% trans "Output" %}:</h4>
					<ul>
						{% for item in commitment.process.outgoing_commitments %}
							<li>
								<b>{{ item.resource_type.name }}:</b> {% trans "Planned" %}: {{ item.quantity }} {{ item.unit_of_quantity }}</br>
								{% trans "Actual" %}: <input class="input-mini quantity" id="{{ item.id }}" type="text" size="6" value="{{ item.fulfilled_quantity }}" /></br>
								<a href="" role="button" class="btn btn-warning" >{% trans "Failed" %}</a>
							</li>
						{% endfor %}
					</ul>
				{% if commitment.process.material_requirements %}
					<div>
						<h4>{% trans "Material requirements" %}:</h4>
						{% for item in commitment.process.material_requirements %}
	{% comment %}
						<p style="margin-left: 1em;" >{% trans "Onhand" %}:</p>
						<p style="margin-left: 2em;" >{% trans "Used in this process" %}:</p>
						<p style="margin-left: 1em;" >{% trans "Scheduled for production" %}:</p>
						<p style="margin-left: 1em;" >{% trans "On order" %}:</p>
						<p style="margin-left: 1em;" >{% trans "Not purchased yet" %}:</p>
	{% endcomment %}
						<ul>
							{% if item.resource_type.resources.all %}
								{% for resource in item.resource_type.resources.all %}
									<li>
										<b>{% trans "Onhand" %}: {{ item.resource_type.name }}</b> {{ resource.quantity }} {{ resource.unit_of_quantity }}
									</li>
								{% endfor %}
							{% else %}
								<li>
									<b>{% trans "Not purchased yet" %}: {{ item.resource_type.name }}:</b> {{ item.quantity }} {{ item.unit_of_quantity }}
								</li>
		                        <ul>
									{% for source in item.resource_type.producing_agent_relationships %}
										<li>
											<a href="" role="button" class="btn btn-info" >{% trans "Buy from" %}</a>
											{{ source.agent.name }} {% trans "Lead time" %}: {{ source.lead_time }} {% trans "days" %}
										</li>
									{% endfor %}
								</ul>
							{% endif %}

						</ul>
						{% endfor %}
						
					</div>
				{% endif %}

				{% if commitment.process.tool_requirements %}
					<div>
						<h4>{% trans "Tool requirements" %}:</h4>
	{% comment %}
						<p style="margin-left: 1em;" >{% trans "Onhand" %}:</p>
						<p style="margin-left: 2em;" >{% trans "Used in this process" %}:</p>
						<p style="margin-left: 1em;" >{% trans "Scheduled for production" %}:</p>
						<p style="margin-left: 1em;" >{% trans "On order" %}:</p>
	{% endcomment %}
						<p style="margin-left: 1em;" >{% trans "Not purchased yet" %}:</p>
						<ul>
							{% for item in commitment.process.tool_requirements %}
								<li>
									<b>{{ item.resource_type.name }}:</b> {{ item.quantity }} {{ item.unit_of_quantity }}
								</li>
		                        <ul>
									{% for source in item.resource_type.producing_agent_relationships %}
										<li>
											<a href="" role="button" class="btn btn-info" >{% trans "Buy from" %}</a>
											{{ source.agent.name }} {% trans "Lead time" %}: {{ source.lead_time }} {% trans "days" %}
										</li>
									{% endfor %}
								</ul>
							{% endfor %}
						</ul>
					</div>
				{% endif %}

				{% if others_working %}
					<p style="margin-left: 1em;" >{% trans "Others working on this process" %}:</p>
					<ul>
						{% for item in others_working %}
							<li>
								<b>{{ item }}
							</li>

						{% endfor %}
					</ul>

				{% endif %}
			</div>
		</div>


	</div>
    </div>
{% endblock %}
{% block extra_script %}
<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
{% endblock %}

{% block extra_body %}
	{{ block.super }}

    <script type="text/javascript">

	var start = new Date();
    var duration = 0;

	$(document).ready(function(){
		$('.date-entry').datepicker({ dateFormat: "yy-mm-dd" });

		$("#start").click(function() {
			$("#start").attr("disabled", "disabled");
			$("#stop").removeAttr("disabled");  
            start = new Date();
		});

		$("#stop").click(function() {
			$("#stop").attr("disabled", "disabled");
			$("#start").removeAttr("disabled"); 
            var stop = new Date();
			duration += Math.round((stop - start) / 60000);
        	var days = Math.floor(duration / 1440);
        	var hours = Math.floor((duration - (days * 1440)) / 60);
            var mins = Math.round(duration - (days * 1440) - (hours * 60));
			$("#id_quantity_0").val(days);
			$("#id_quantity_1").val(hours);
			$("#id_quantity_2").val(mins);
			//alert("duration = " + duration);
		});

		$(".quantity").blur(function() 
		{
			var quantity = this.value;
			var wholeNbrs = quantity;
			var decimals = "";
			if (quantity.indexOf(".") > -1)
			{
				var qtySplit = quantity.split(".");
				wholeNbrs = qtySplit[0];
				decimals = qtySplit[1];
			}
			
			if ($.isNumeric(quantity))
			{
				var combined = wholeNbrs.length + decimals.length;
				if (combined<=8 && decimals.length<=2)
				{
					var id = this.id;
					$.post("{% url production_event_for_commitment %}",  { id: id, quantity: quantity });
				}
				else
				{
					alert(quantity + " can only have 8 overall digits with 2 decimal places.");
					this.value = quantity;
				}
			}
			else
			{
				alert(quantity + " is not a number");
				this.value = quantity;
			}
		});

	}); // end document.ready

	$(document).ajaxSend(function(event, xhr, settings) 
	{
		function getCookie(name) 
		{
		    var cookieValue = null;
		    if (document.cookie && document.cookie != '') 
			{
		        var cookies = document.cookie.split(';');
		        for (var i = 0; i < cookies.length; i++) 
				{
		            var cookie = jQuery.trim(cookies[i]);
		            // Does this cookie string begin with the name we want?
		            if (cookie.substring(0, name.length + 1) == (name + '=')) 
					{
		                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
		                break;
		            }
		        }
		    }
		    return cookieValue;
    	}

		function sameOrigin(url) 
		{
		    // url could be relative or scheme relative or absolute
		    var host = document.location.host; // host + port
		    var protocol = document.location.protocol;
		    var sr_origin = '//' + host;
		    var origin = protocol + sr_origin;
		    // Allow absolute or scheme relative URLs to same origin
		    return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
		        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
		        // or any other URL that isn't scheme relative or absolute i.e relative.
		        !(/^(\/\/|http:|https:).*/.test(url));
		}

		function safeMethod(method) 
		{
		    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		}

		if (!safeMethod(settings.type) && sameOrigin(settings.url)) 
		{
		    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
		}
	});
    </script>

{% endblock %}
